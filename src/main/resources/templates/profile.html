<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>í”„ë¡œí•„ - Date App</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
    <style>
        .profile-info {
            margin: 15px 0;
        }
        .profile-info label {
            font-weight: bold;
            color: #666;
            margin-right: 10px;
        }
        .profile-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .danger-button {
            background: rgba(255, 100, 100, 0.1);
            border: 1px solid rgba(255, 100, 100, 0.3);
            color: #ff6464;
        }
        .danger-button:hover {
            background: rgba(255, 100, 100, 0.2);
        }
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }
        .tag {
            background: rgba(255, 255, 255, 0.3);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="glass-nav">
            <h1><i class="fas fa-user-circle"></i> í”„ë¡œí•„</h1>
            <div class="nav-actions">
                <a href="/home" class="glass-button">
                    <i class="fas fa-home"></i> í™ˆìœ¼ë¡œ
                </a>
                <a href="/logout" id="logout-link" class="glass-button">
                    <i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ
                </a>
            </div>
        </nav>

        <div class="main-content">
            <div id="message"></div>

            <div id="profile-section" style="display:none;" class="glass-card">
                <div class="profile-info">
                    <label><i class="fas fa-envelope"></i> ì´ë©”ì¼:</label>
                    <span id="userEmail"></span>
                </div>
                <div class="profile-info">
                    <label><i class="fas fa-user"></i> ì´ë¦„:</label>
                    <span id="name"></span>
                </div>
                <div class="profile-info">
                    <label><i class="fas fa-venus-mars"></i> ì„±ë³„:</label>
                    <span id="gender"></span>
                </div>
                <div class="profile-info">
                    <label><i class="fas fa-birthday-cake"></i> ë‚˜ì´:</label>
                    <span id="birthdate"></span>
                </div>
                <div class="profile-info">
                    <label><i class="fas fa-comment"></i> ìê¸°ì†Œê°œ:</label>
                    <p id="bio" style="margin: 10px 0; white-space: pre-line;"></p>
                </div>
                <div class="profile-info">
                    <label><i class="fas fa-brain"></i> MBTI:</label>
                    <span id="mbti"></span>
                </div>
                <div class="profile-info">
                    <label><i class="fas fa-tags"></i> ì„±ê²© íƒœê·¸:</label>
                    <div class="tag-list">
                        <div id="tags"></div>
                    </div>
                </div>

                <div class="profile-actions">
                    <a href="/profile/edit" class="glass-button">
                        <i class="fas fa-edit"></i> í”„ë¡œí•„ ìˆ˜ì •
                    </a>
                    <button type="button" id="delete-account" class="glass-button danger-button">
                        <i class="fas fa-user-times"></i> íšŒì›íƒˆí‡´
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC_fS_I_g0jicSPKLqBxF8if2ffnDKrvNM",
        authDomain: "date-app-41a1c.firebaseapp.com",
        projectId: "date-app-41a1c",
        storageBucket: "date-app-41a1c.firebasestorage.app",
        messagingSenderId: "950558236414",
        appId: "1:950558236414:web:f65dad635607345aa8cfaf",
        measurementId: "G-EBTEFW9PDH"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    document.getElementById('delete-account').addEventListener('click', async function() {
        if (!confirm('ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? íƒˆí‡´í•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
            return;
        }

        try {
            const user = auth.currentUser;
            if (!user) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.replace('/login');
                return;
            }

            const uid = user.uid;

            await database.ref('users/' + uid).remove();
            console.log("ğŸ—‘ï¸ Realtime Database ì‚¬ìš©ì ë°ì´í„° ì‚­ì œ ì™„ë£Œ");

            await user.delete();
            console.log("âœ… Firebase Authentication ì‚¬ìš©ì ì‚­ì œ ì™„ë£Œ");

            alert('âœ… íšŒì›íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            location.replace('/login');
        } catch (error) {
            console.error('íšŒì›íƒˆí‡´ ì‹¤íŒ¨:', error);

            if (error.code === 'auth/requires-recent-login') {
                alert('â— ìµœê·¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í›„ íƒˆí‡´í•´ì£¼ì„¸ìš”.');
                await auth.signOut();
                location.replace('/login');
            } else {
                alert('íšŒì›íƒˆí‡´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.message || ''));
            }
        }
    });

    const token = localStorage.getItem('jwtToken');

    if (!token) {
        window.location.href = '/login';
    } else {
        fetch('/api/home', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ì¸ì¦ ì‹¤íŒ¨. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('profile-section').style.display = 'block';
                document.getElementById('userEmail').textContent = data.userEmail;
                if (data.profile) {
                    document.getElementById('name').textContent = data.profile.name || '';
                    document.getElementById('gender').textContent = data.profile.gender || '';
                    const rawBirthdate = data.profile.birthdate || '';
                    const age = rawBirthdate ? calculateKoreanAge(rawBirthdate) : '-';
                    document.getElementById('birthdate').textContent = 'ë§Œ ' + age + 'ì„¸';
                    document.getElementById('bio').textContent = data.profile.bio || '';

                    const personality = data.profile.personality || {};
                    document.getElementById('mbti').textContent = personality.mbti || '-';
                    
                    // íƒœê·¸ë¥¼ ê°œë³„ íƒœê·¸ ìš”ì†Œë¡œ ë³€í™˜
                    const tagsContainer = document.getElementById('tags');
                    const tags = personality.tags || [];
                    tagsContainer.innerHTML = tags.map(tag => `<span class="tag">${tag}</span>`).join('');
                }
            })
            .catch(error => {
                console.error(error);
                localStorage.removeItem('jwtToken');
                window.location.href = '/login';
            });
    }

    document.getElementById('logout-link').addEventListener('click', function() {
        localStorage.removeItem('jwtToken');
    });

    function calculateKoreanAge(birthdateStr) {
        const today = new Date();
        const birthDate = new Date(birthdateStr);

        let age = today.getFullYear() - birthDate.getFullYear();

        const isBirthdayPassed =
            today.getMonth() > birthDate.getMonth() ||
            (today.getMonth() === birthDate.getMonth() && today.getDate() >= birthDate.getDate());

        if (!isBirthdayPassed) {
            age--;
        }

        return age;
    }
</script>
</body>
</html>
